<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>C++ embedded scripting&#58; ChaiScript recipes | Raycast</title>

		<link href="/css/vendor/bootstrap.min.css" rel="stylesheet">
    	<link href="/css/flat-ui.min.css" rel="stylesheet">
		<link rel="stylesheet" href="/css/style.css"/>
		<link rel="stylesheet" href="/css/syntax.css" media="screen"/>
		<link rel="stylesheet" href="/css/fancybox/jquery.fancybox.css" media="screen"/>
		<link rel="stylesheet" href="/css/fancybox/jquery.fancybox-buttons.css" media="screen" />
		<link rel="stylesheet" href="/css/fancybox/jquery.fancybox-thumbs.css" media="screen" />
		<link rel="shortcut icon" type="image/png" href="/images/gamepad.png">
	</head>
	<body>
		<div class="container page">
			<div class="navbar navbar-default" role="navigation">
	<div class="container-fluid">
		<div class="navbar-header">
			<a class="navbar-brand" href="/">
				<img src="/images/gamepad_large.png"/>
			</a>
			<div class="navbar-text">Home page of one programmer</div>
		</div>
		<ul class="nav navbar-nav navbar-right">
			<li><a href="/">Articles</a></li>
			<li><a href="/portfolio/">Portfolio</a></li>
			<li><a href="/about/">About</a></li>
		</ul>
	</div>
</div>


			<div class="content">
				<div class="article">
	<div class="row">
		<div class="col-xs-12">
			<h2>C++ embedded scripting&#58; ChaiScript recipes</h2>
			
				<span class="small text-muted">07 Jul 2015</span>
			
		</div>
	</div>
	
	<div class="article-content">
		<p><a href="/chaiscript-recipes#recipes">Go to recipes</a></p>

<p>Currently there are several options for embedding scripting into your C++ application. Among the most well-known, from my experience, are
<a href="http://www.lua.org/">Lua</a>, <a href="http://www.angelcode.com/angelscript/">AngelScript</a> and the recent addition - <a href="http://chaiscript.com/">ChaiScript</a>.
I’ve been evaluating these languages for some time recently and my main impressions are:</p>

<!--break-->

<ul>
  <li>Lua has many binding libraries, but very few of them support smart pointers and std containers like <code class="highlighter-rouge">std::string</code> at the same time (a must-have I think). Many of them
are abandoned, even the most well-known LubBind (sadly). Some libraries require Boost to compile, which might not be an option for some projects.
Some libraries don’t compile in MSVS 2013 (even with November CTP) due to the extensive use of C++11/14. Others have poor documentation…
I personally can recommend <a href="https://github.com/tomaka/luawrapper">luawrapper</a> because it has one of the richest feature sets and a fairly good documentation.
Unfortunately it requires Boost and compiles in MSVS 2013 Nov CTP only after some modifications (removing <code class="highlighter-rouge">constexpr</code> and ref-value qualifiers).</li>
  <li>AngelScript has a built-in mechanism for embedding into C++ programs, but it looks bulky and (probably - not sure) you have to register smart pointers manually
in order to use them. Overall, the syntax leaves you with many ways to make a mistake in your bindings.</li>
  <li>ChaiScript is a header-only engine (!), heavily template-based and increases the compilation time/binary size significantly. It is, however, designed
for embedded into C++ programs and thus provides a very straightforward and transparent way of doing this. Most of the time you understand what’s going on
and why. The language syntax looks like a mix of JavaScript and C++.</li>
</ul>

<p>If you are reading this article chances are you’re deciding between those three languages, or have already chosen ChaiScript, but
can’t find some necessary information in the official documentation. In this (updateable) post I’ll gather a few ChaiScript tips and code snippets
that were most difficult for me to discover. They come either from long series of experiments or from the official forum and
careful reading of examples and tests. This article assumes that you have already read the documentation, looked through the
<a href="https://github.com/ChaiScript/ChaiScript/blob/master/cheatsheet.md">cheat sheet</a>, <a href="https://github.com/ChaiScript/ChaiScript/tree/master/samples">samples</a>
and <a href="https://github.com/ChaiScript/ChaiScript/tree/master/unittests">unit tests</a>.</p>

<div id="recipes"></div>
<p>Bootstrapping a project (for impatient):</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;chaiscript.hpp&gt;
#include &lt;chaiscript_stdlib.hpp&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">chaiscript</span><span class="o">::</span><span class="n">ChaiScript</span> <span class="n">engine</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">Std_Lib</span><span class="o">::</span><span class="n">library</span><span class="p">());</span>
    <span class="c1">// ... register API for your scripts
</span>    <span class="n">engine</span><span class="p">.</span><span class="n">eval_file</span><span class="p">(</span><span class="s">"script.chai"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Attaching C++ function to a script object:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Host program
</span>
<span class="kt">void</span> <span class="nf">logMsg</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...
</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logMsg</span><span class="p">),</span> <span class="s">"log"</span><span class="p">);</span>

<span class="c1">// Script
</span>
<span class="k">class</span> <span class="nc">Test</span>
<span class="p">{</span>
    <span class="n">def</span> <span class="n">Test</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="n">var</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">create</span><span class="p">(</span><span class="s">"Test"</span><span class="p">);</span>
<span class="n">t</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"abc"</span><span class="p">);</span>

<span class="c1">// Output
</span>
<span class="n">abc</span></code></pre></figure>

<p>Inheritance, <code class="highlighter-rouge">shared_ptr</code> to base class, polymorphic function call:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Host program
</span>
<span class="k">struct</span> <span class="n">Base</span>
<span class="p">{</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">Base</span><span class="p">()</span> <span class="p">{}</span> <span class="c1">// ChaiScript requires classes to be polymorphic for inheritance to work
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">A</span><span class="o">:</span> <span class="n">Base</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">func</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="s">"A::func"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">B</span><span class="o">:</span> <span class="n">Base</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">func</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="s">"B::func"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Yes, you can pass shared_ptr to your script
</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span> <span class="n">getSmth</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">"A"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">"B"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...
</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">user_type</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span><span class="p">(),</span> <span class="s">"Base"</span><span class="p">);</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">user_type</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">(),</span> <span class="s">"A"</span><span class="p">);</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">user_type</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">(),</span> <span class="s">"B"</span><span class="p">);</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">base_class</span><span class="o">&lt;</span><span class="n">Base</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span><span class="p">());</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">base_class</span><span class="o">&lt;</span><span class="n">Base</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span><span class="p">());</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="o">::</span><span class="n">func</span><span class="p">),</span> <span class="s">"func"</span><span class="p">);</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="o">&amp;</span><span class="n">B</span><span class="o">::</span><span class="n">func</span><span class="p">),</span> <span class="s">"func"</span><span class="p">);</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="o">&amp;</span><span class="n">getSmth</span><span class="p">),</span> <span class="s">"getSmth"</span><span class="p">);</span>


<span class="c1">// Script
</span>
<span class="n">var</span> <span class="n">a</span> <span class="o">=</span> <span class="n">getSmth</span><span class="p">(</span><span class="s">"A"</span><span class="p">);</span>
<span class="n">a</span><span class="p">.</span><span class="n">func</span><span class="p">();</span>

<span class="n">var</span> <span class="n">b</span> <span class="o">=</span> <span class="n">getSmth</span><span class="p">(</span><span class="s">"B"</span><span class="p">);</span>
<span class="n">b</span><span class="p">.</span><span class="n">func</span><span class="p">();</span>

<span class="c1">// Output
</span>
<span class="n">A</span><span class="o">::</span><span class="n">func</span>
<span class="n">B</span><span class="o">::</span><span class="n">func</span></code></pre></figure>

<p>Creating script object from C++, storing it, calling its functions, passing it back to script:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Host program
</span>
<span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span> <span class="n">obj</span><span class="p">;</span>

<span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span><span class="o">&amp;</span> <span class="n">create</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">className</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="n">eval</span><span class="o">&lt;</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span><span class="o">&gt;</span><span class="p">(</span><span class="n">className</span> <span class="o">+</span> <span class="s">"()"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">callFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Member functions require an implicit first parameter - pointer to the object
</span>    <span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="n">eval</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"func"</span><span class="p">);</span>
    <span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//...
</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="o">&amp;</span><span class="n">create</span><span class="p">),</span> <span class="s">"create"</span><span class="p">);</span>
<span class="n">engine</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callFunc</span><span class="p">),</span> <span class="s">"callFunc"</span><span class="p">);</span>


<span class="c1">// Script
</span>
<span class="k">class</span> <span class="nc">Test</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">id</span><span class="p">;</span>

    <span class="n">def</span> <span class="nf">Test</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">def</span> <span class="nf">func</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ":=" here is important. If it were "=", ChaiScript would create a deep copy
// and you'll end up having two copies of Test object
</span><span class="n">var</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">create</span><span class="p">(</span><span class="s">"Test"</span><span class="p">);</span>
<span class="n">t</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">100500</span><span class="p">;</span>
<span class="n">t</span><span class="p">.</span><span class="n">func</span><span class="p">();</span>
<span class="n">callFunc</span><span class="p">();</span>

<span class="c1">// Output
</span>
<span class="mi">100500</span>
<span class="mi">100500</span></code></pre></figure>

<p>Return any object from C++ function to ChaiScript:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Use Boxed_Value as return value
</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span> <span class="n">func</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="s">"Foo"</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="s">"Bar"</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">));</span>
	<span class="c1">// .. and so on
</span>	<span class="k">return</span> <span class="n">chaiscript</span><span class="o">::</span><span class="n">Boxed_Value</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Register function as normal
</span><span class="n">script</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">chaiscript</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="p">),</span> <span class="s">"func"</span><span class="p">);</span></code></pre></figure>


	</div>
</div>

			<div>

			
	<div id="disqus_thread">
	</div>
	<script type="text/javascript">
		var disqus_shortname = 'raycastnet'; // required: replace example with your forum shortname
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


		</div>

		<div class="footer">
	<p class="text-muted">© 2014-2016 Aleksey Fedotov</p>
</div>

<script src="/js/vendor/jquery.min.js"></script>
<script src="/js/vendor/video.js"></script>
<script src="/js/flat-ui.min.js"></script>
<script src="/js/fancybox/jquery.fancybox.pack.js"></script>
<script src="/js/fancybox/jquery.fancybox-buttons.js"></script>
<script src="/js/fancybox/jquery.fancybox-media.js"></script>
<script src="/js/fancybox/jquery.fancybox-thumbs.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-50872849-1', 'raycast.net');
  ga('send', 'pageview', {
    "page": "/chaiscript-recipes",
    "title": 'C++ embedded scripting&#58; ChaiScript recipes'
  });
</script>

<script>
	$(document).ready(function() {
		$(".lightbox").fancybox();
	});
</script>

	</body>
</html>
